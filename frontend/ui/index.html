<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPK NEXUS | Portal Central</title>
    <link rel="stylesheet" href="/assets/style_nexus.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
</head>

<body>
    <div class="app-container">
        <header>
            <div class="logo-container">
                <h1>RPK<span>NEXUS</span></h1>
            </div>
            <div class="status-badge">
                <div class="dot"></div>
                <span>DATABASE ONLINE</span>
            </div>
        </header>

        <main>
            <!-- KPIs Unificados -->
            <div class="kpi-grid">
                <div class="card">
                    <h3>STOCK</h3>
                    <div class="value" id="stock-val">---</div>
                    <div class="label">Cantidad en piezas</div>
                </div>
                <div class="card">
                    <h3>Saturaci√≥n Media</h3>
                    <div class="value" id="sat-val">74%</div>
                    <div class="label">Centros de Trabajo</div>
                </div>
                <div class="card">
                    <h3>Cobertura Real</h3>
                    <div class="value" id="cob-val">12.4</div>
                    <div class="label">D√≠as de producci√≥n</div>
                </div>
            </div>

            <!-- M√≥dulos Nexus -->
            <div class="modules-section">
                <div class="module-box">
                    <h2>üì¶ Dashboard de Stock</h2>
                    <p>Acceso al an√°lisis detallado de existencias, ubicaciones y obsoletos.</p>
                    <a href="/mod/stock" class="btn-launch">Abrir M√≥dulo</a>
                </div>
                <div class="module-box">
                    <h2>‚è≥ Dashboard de Tiempos</h2>
                    <p>Visualizaci√≥n de cargas de trabajo, OEE y saturaci√≥n por m√°quina.</p>
                    <a href="/mod/tiempos" class="btn-launch">Abrir M√≥dulo</a>
                </div>
                <div class="module-box">
                    <h2>üéÆ Simulador de Producci√≥n</h2>
                    <p>Simulaci√≥n de escenarios, cambios de cadencia y optimizaci√≥n de fleje.</p>
                    <a href="/mod/simulador" class="btn-launch">Abrir Simulador</a>
                </div>
                <!-- NUEVO MODULO PEDIDOS -->
                <div class="module-box" style="border-left: 4px solid var(--rpk-red)">
                    <h2>üí∞ Pedidos de Venta</h2>
                    <p>An√°lisis de pedidos pendientes, fechas de entrega e importe total de cartera.</p>
                    <a href="/mod/pedidos" class="btn-launch">Abrir Dashboard</a>
                </div>
            </div>
        </main>

        <!-- Gemini Assistant Popup -->
        <div class="chat-trigger" onclick="toggleChat()">
            ü§ñ
        </div>

        <div class="chat-popup" id="chatPopup">
            <div class="chat-header">
                <strong>Nexus Assistant</strong>
                <span style="cursor:pointer" onclick="toggleChat()">‚úï</span>
            </div>
            <div class="chat-body" id="chatBody">
                <p style="color:var(--text-muted)">Hola Ismael, soy el asistente NEXUS. ¬øEn qu√© puedo ayudarte hoy?</p>
            </div>
            <div class="chat-input-area">
                <input type="text" class="chat-input" id="chatInput" placeholder="Pregunta algo..."
                    onkeypress="handleKey(event)">
                <button class="btn-send" onclick="sendMessage()">‚û§</button>
            </div>
        </div>
    </div>

    <script>
        // Cargar Datos Iniciales (Hub Stats)
        fetch('/api/v1/hub_stats')
            .then(r => r.json())
            .then(data => {
                if (data.error) return;
                // 1. Stock (Pzs)
                document.getElementById('stock-val').innerText = data.stock.total.toLocaleString();
                // 2. Saturaci√≥n Media
                document.getElementById('sat-val').innerText = data.saturation + '%';
                // 3. Cobertura
                document.getElementById('cob-val').innerText = data.cobertura;
            });

        function toggleChat() {
            document.getElementById('chatPopup').classList.toggle('active');
        }

        function handleKey(e) {
            if (e.key === 'Enter') sendMessage();
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const body = document.getElementById('chatBody');
            const text = input.value.trim();
            if (!text) return;

            // User msg
            body.innerHTML += `<p style="margin-top:10px"><strong>T√∫:</strong> ${text}</p>`;
            input.value = '';

            // API Call
            const res = await fetch('/api/v1/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: text })
            });
            const data = await res.json();

            // Nexus response
            body.innerHTML += `<p style="margin-top:10px; color:var(--rpk-red); white-space: pre-wrap;"><strong>Nexus:</strong> ${data.response}</p>`;
            body.scrollTop = body.scrollHeight;
        }
    </script>
</body>

</html>